<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>更新日志 - OTRS工单数据分析系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <style>
        .update-log-card {
            border-left: 4px solid #007bff;
            margin-bottom: 1rem;
        }
        .update-log-success {
            border-left-color: #28a745;
        }
        .update-log-failed {
            border-left-color: #dc3545;
        }
        .update-log-in-progress {
            border-left-color: #ffc107;
        }
        .step-log {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
        .step-success {
            background-color: #d4edda;
            border-left: 3px solid #28a745;
        }
        .step-failed {
            background-color: #f8d7da;
            border-left: 3px solid #dc3545;
        }
        .step-pending {
            background-color: #fff3cd;
            border-left: 3px solid #ffc107;
        }
        .progress-container {
            margin: 1rem 0;
        }
        .file-changes {
            font-family: monospace;
            font-size: 0.9rem;
        }
        .commit-info {
            background-color: #e9ecef;
            padding: 0.75rem;
            border-radius: 4px;
            margin-top: 1rem;
        }
        .status-badge {
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row mt-3">
            <div class="col">
                <h2><i class="fas fa-history me-2"></i>更新日志</h2>
                <p class="text-muted">查看应用程序更新操作的详细记录</p>
            </div>
            <div class="col-auto">
                <a href="/" class="btn btn-outline-secondary">
                    <i class="fas fa-home me-1"></i>返回首页
                </a>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="text-center mt-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <p class="mt-2">正在加载更新日志...</p>
        </div>

        <!-- Update Logs Container -->
        <div id="updateLogsContainer" class="mt-4" style="display: none;">
            <!-- Filter Controls -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-filter"></i></span>
                        <select id="statusFilter" class="form-select">
                            <option value="all">所有状态</option>
                            <option value="completed">已完成</option>
                            <option value="failed">失败</option>
                            <option value="started">进行中</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" id="searchFilter" class="form-control" placeholder="搜索版本号...">
                    </div>
                </div>
            </div>

            <!-- Update Logs List -->
            <div id="updateLogsList"></div>

            <!-- Load More Button -->
            <div class="text-center mt-4">
                <button id="loadMoreBtn" class="btn btn-outline-primary" style="display: none;">
                    <i class="fas fa-plus me-1"></i>加载更多
                </button>
            </div>
        </div>

        <!-- No Data Message -->
        <div id="noDataMessage" class="text-center mt-5" style="display: none;">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">暂无更新记录</h4>
            <p class="text-muted">尚未执行过任何更新操作</p>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="alert alert-danger mt-4" style="display: none;">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span id="errorText"></span>
        </div>
    </div>

    <!-- Update Log Details Modal -->
    <div class="modal fade" id="updateLogModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">更新详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="updateLogDetails">
                    <!-- Details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPage = 1;
        const pageSize = 10;
        let allLogs = [];
        let filteredLogs = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadUpdateLogs();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Filter events
            document.getElementById('statusFilter').addEventListener('change', filterLogs);
            document.getElementById('searchFilter').addEventListener('input', filterLogs);
            
            // Load more button
            document.getElementById('loadMoreBtn').addEventListener('click', loadMoreLogs);
        }

        async function loadUpdateLogs() {
            try {
                showLoading();
                
                const response = await fetch('/api/update/logs?limit=100');
                const result = await response.json();
                
                if (result.success) {
                    allLogs = result.logs;
                    filterLogs();
                    hideLoading();
                } else {
                    showError(result.error || '加载更新日志失败');
                }
            } catch (error) {
                showError('网络错误: ' + error.message);
            }
        }

        function filterLogs() {
            const statusFilter = document.getElementById('statusFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
            
            filteredLogs = allLogs.filter(log => {
                // Status filter
                if (statusFilter !== 'all') {
                    if (statusFilter === 'completed' && log.status !== 'completed') return false;
                    if (statusFilter === 'failed' && log.status !== 'failed') return false;
                    if (statusFilter === 'started' && !['started', 'in_progress'].includes(log.status)) return false;
                }
                
                // Search filter
                if (searchFilter && !log.target_version.toLowerCase().includes(searchFilter)) {
                    return false;
                }
                
                return true;
            });
            
            renderLogs();
        }

        function renderLogs() {
            const container = document.getElementById('updateLogsList');
            const noDataMessage = document.getElementById('noDataMessage');
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            
            if (filteredLogs.length === 0) {
                container.innerHTML = '';
                noDataMessage.style.display = 'block';
                loadMoreBtn.style.display = 'none';
                return;
            }
            
            noDataMessage.style.display = 'none';
            
            const logsToShow = filteredLogs.slice(0, currentPage * pageSize);
            const hasMore = filteredLogs.length > currentPage * pageSize;
            
            container.innerHTML = logsToShow.map(log => createLogCard(log)).join('');
            
            loadMoreBtn.style.display = hasMore ? 'block' : 'none';
        }

        function createLogCard(log) {
            const statusClass = getStatusClass(log.status);
            const statusText = getStatusText(log.status);
            const statusIcon = getStatusIcon(log.status);
            
            return `
                <div class="card update-log-card ${statusClass} mb-3">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h5 class="card-title">
                                    <i class="${statusIcon} me-2"></i>
                                    ${log.target_version}
                                    ${log.force_reinstall ? '<span class="badge bg-warning ms-2">强制重新安装</span>' : ''}
                                </h5>
                                <p class="card-text mb-1">
                                    <small class="text-muted">
                                        <i class="fas fa-clock me-1"></i>
                                        开始时间: ${formatDateTime(log.started_at)}
                                        ${log.completed_at ? ` | 完成时间: ${formatDateTime(log.completed_at)}` : ''}
                                    </small>
                                </p>
                                <p class="card-text mb-1">
                                    <small class="text-muted">
                                        <i class="fas fa-code-branch me-1"></i>
                                        当前版本: ${log.current_version || 'N/A'} → 目标版本: ${log.target_version}
                                    </small>
                                </p>
                                ${log.error_message ? `
                                    <p class="card-text mb-1">
                                        <small class="text-danger">
                                            <i class="fas fa-exclamation-circle me-1"></i>
                                            错误: ${log.error_message}
                                        </small>
                                    </p>
                                ` : ''}
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="badge ${getStatusBadgeClass(log.status)} status-badge">
                                    ${statusText}
                                </span>
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="showLogDetails('${log.update_id}')">
                                        <i class="fas fa-info-circle me-1"></i>详情
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Progress Bar -->
                        ${log.status === 'started' || log.status === 'in_progress' ? `
                            <div class="progress-container">
                                <div class="progress">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" 
                                         style="width: ${log.progress_percentage}%">
                                        ${log.progress_percentage}%
                                    </div>
                                </div>
                                <small class="text-muted">
                                    步骤 ${log.completed_steps}/${log.total_steps}
                                </small>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        async function showLogDetails(updateId) {
            try {
                const response = await fetch(`/api/update/logs/${updateId}`);
                const result = await response.json();
                
                if (result.success) {
                    displayLogDetails(result.log);
                } else {
                    alert('加载更新详情失败: ' + result.error);
                }
            } catch (error) {
                alert('网络错误: ' + error.message);
            }
        }

        function displayLogDetails(log) {
            const modalBody = document.getElementById('updateLogDetails');
            
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>基本信息</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>更新ID:</strong></td>
                                <td>${log.update_id}</td>
                            </tr>
                            <tr>
                                <td><strong>目标版本:</strong></td>
                                <td>${log.target_version}</td>
                            </tr>
                            <tr>
                                <td><strong>当前版本:</strong></td>
                                <td>${log.current_version || 'N/A'}</td>
                            </tr>
                            <tr>
                                <td><strong>强制重新安装:</strong></td>
                                <td>${log.force_reinstall ? '是' : '否'}</td>
                            </tr>
                            <tr>
                                <td><strong>状态:</strong></td>
                                <td><span class="badge ${getStatusBadgeClass(log.status)}">${getStatusText(log.status)}</span></td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>时间信息</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>开始时间:</strong></td>
                                <td>${formatDateTime(log.started_at)}</td>
                            </tr>
                            <tr>
                                <td><strong>完成时间:</strong></td>
                                <td>${log.completed_at ? formatDateTime(log.completed_at) : '进行中'}</td>
                            </tr>
                            <tr>
                                <td><strong>持续时间:</strong></td>
                                <td>${log.duration_seconds ? formatDuration(log.duration_seconds) : 'N/A'}</td>
                            </tr>
                        </table>
                    </div>
                </div>

                ${log.commit_hash ? `
                    <div class="commit-info">
                        <h6>提交信息</h6>
                        <p><strong>提交哈希:</strong> ${log.commit_hash}</p>
                        <p><strong>提交信息:</strong> ${log.commit_message}</p>
                        <p><strong>作者:</strong> ${log.commit_author}</p>
                        <p><strong>提交时间:</strong> ${formatDateTime(log.commit_date)}</p>
                    </div>
                ` : ''}

                <div class="mt-3">
                    <h6>执行步骤</h6>
                    ${log.steps && log.steps.length > 0 ? 
                        log.steps.map(step => createStepCard(step)).join('') : 
                        '<p class="text-muted">暂无步骤信息</p>'
                    }
                </div>

                ${log.error_message ? `
                    <div class="alert alert-danger mt-3">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>错误信息</h6>
                        <p class="mb-0">${log.error_message}</p>
                        ${log.error_details ? `<pre class="mt-2">${log.error_details}</pre>` : ''}
                    </div>
                ` : ''}
            `;
            
            new bootstrap.Modal(document.getElementById('updateLogModal')).show();
        }

        function createStepCard(step) {
            const stepClass = getStepClass(step.status);
            return `
                <div class="step-log ${stepClass}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${getStepName(step.step_name)}</strong>
                            <small class="text-muted ms-2">#${step.step_order}</small>
                        </div>
                        <div>
                            <span class="badge ${getStepBadgeClass(step.status)}">
                                ${getStepStatusText(step.status)}
                            </span>
                        </div>
                    </div>
                    ${step.started_at ? `
                        <div class="mt-1">
                            <small class="text-muted">
                                开始: ${formatDateTime(step.started_at)}
                                ${step.completed_at ? ` | 完成: ${formatDateTime(step.completed_at)}` : ''}
                                ${step.duration_seconds ? ` | 耗时: ${formatDuration(step.duration_seconds)}` : ''}
                            </small>
                        </div>
                    ` : ''}
                    ${step.output ? `
                        <div class="mt-1">
                            <small><strong>输出:</strong> ${step.output}</small>
                        </div>
                    ` : ''}
                    ${step.error_message ? `
                        <div class="mt-1">
                            <small class="text-danger"><strong>错误:</strong> ${step.error_message}</small>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Helper functions
        function getStatusClass(status) {
            switch (status) {
                case 'completed': return 'update-log-success';
                case 'failed': return 'update-log-failed';
                case 'started':
                case 'in_progress': return 'update-log-in-progress';
                default: return '';
            }
        }

        function getStatusText(status) {
            switch (status) {
                case 'completed': return '已完成';
                case 'failed': return '失败';
                case 'started': return '已开始';
                case 'in_progress': return '进行中';
                default: return status;
            }
        }

        function getStatusIcon(status) {
            switch (status) {
                case 'completed': return 'fas fa-check-circle text-success';
                case 'failed': return 'fas fa-times-circle text-danger';
                case 'started':
                case 'in_progress': return 'fas fa-sync-alt text-warning';
                default: return 'fas fa-info-circle text-secondary';
            }
        }

        function getStatusBadgeClass(status) {
            switch (status) {
                case 'completed': return 'bg-success';
                case 'failed': return 'bg-danger';
                case 'started':
                case 'in_progress': return 'bg-warning';
                default: return 'bg-secondary';
            }
        }

        function getStepClass(status) {
            switch (status) {
                case 'completed': return 'step-success';
                case 'failed': return 'step-failed';
                case 'started': return 'step-pending';
                default: return '';
            }
        }

        function getStepName(stepName) {
            const stepNames = {
                'backup_database': '备份数据库',
                'fetch_repository': '获取仓库更新',
                'checkout_version': '检出目标版本',
                'pull_changes': '拉取代码变更',
                'install_dependencies': '安装依赖包',
                'run_migrations': '执行数据库迁移',
                'restart_application': '重启应用程序'
            };
            return stepNames[stepName] || stepName;
        }

        function getStepStatusText(status) {
            switch (status) {
                case 'completed': return '已完成';
                case 'failed': return '失败';
                case 'started': return '进行中';
                default: return status;
            }
        }

        function getStepBadgeClass(status) {
            switch (status) {
                case 'completed': return 'bg-success';
                case 'failed': return 'bg-danger';
                case 'started': return 'bg-warning';
                default: return 'bg-secondary';
            }
        }

        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return 'N/A';
            try {
                const date = new Date(dateTimeStr);
                return date.toLocaleString('zh-CN');
            } catch (e) {
                return dateTimeStr;
            }
        }

        function formatDuration(seconds) {
            if (seconds < 60) {
                return `${seconds}秒`;
            } else if (seconds < 3600) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes}分${remainingSeconds}秒`;
            } else {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                return `${hours}小时${minutes}分`;
            }
        }

        function loadMoreLogs() {
            currentPage++;
            renderLogs();
        }

        function showLoading() {
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('updateLogsContainer').style.display = 'none';
            document.getElementById('noDataMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('updateLogsContainer').style.display = 'block';
        }

        function showError(message) {
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('updateLogsContainer').style.display = 'none';
            document.getElementById('noDataMessage').style.display = 'none';
            
            const errorElement = document.getElementById('errorMessage');
            document.getElementById('errorText').textContent = message;
            errorElement.style.display = 'block';
        }
    </script>
</body>
</html>

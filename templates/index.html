<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTRS Ticket Analysis</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v={{ APP_VERSION }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Unified Navigation -->
        <nav class="unified-nav">
            <div class="nav-links">
                <a href="{{ url_for('index') }}" class="nav-link active">首页</a>
                <a href="{{ url_for('database_page') }}" class="nav-link">数据库统计</a>
                <a href="{{ url_for('responsible_stats') }}" class="nav-link">负责人统计</a>
                <a href="{{ url_for('daily_statistics_page') }}" class="nav-link">每日统计</a>
                <a href="{{ url_for('view_uploads') }}" class="nav-link">上传记录</a>
            </div>
        </nav>

        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-title">
                    <h1><i class="fas fa-chart-line"></i> OTRS Ticket Analysis</h1>
                    <p>Upload Excel files to get detailed ticket statistics and visual reports</p>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Latest Upload Info Section -->
            <section id="latestUploadSection" class="latest-upload-section">
                <div class="latest-upload-card">
                    <div class="latest-upload-header">
                        <h3><i class="fas fa-history"></i> 最近更新信息</h3>
                        <div class="update-controls">
                            <button id="checkUpdateButton" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-sync-alt"></i> 检查更新
                            </button>
                            <button id="updateIconButton" class="update-icon-button" style="display: none;" title="发现新版本">
                                <i class="fas fa-rocket"></i>
                                <span id="updateIconBadge" class="update-icon-badge">NEW</span>
                            </button>
                        </div>
                    </div>
                    <div class="latest-upload-content" id="latestUploadContent">
                        <div class="upload-info-loading">
                            <i class="fas fa-spinner fa-spin"></i> 加载中...
                        </div>
                    </div>
                </div>
            </section>

            <!-- Upload Section -->
            <section class="upload-section" style="display: none;">
                <div class="upload-card">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <h2>Upload Excel File</h2>
                    <p>Supports .xlsx and .xls file formats</p>
                    
                    <form id="uploadForm" class="upload-form">
                        <div class="file-input-wrapper">
                            <input type="file" id="fileInput" accept=".xlsx,.xls" class="file-input">
                            <label for="fileInput" class="file-input-label">
                                <i class="fas fa-file-excel"></i>
                                <span>Select Excel File</span>
                            </label>
                        </div>
                        <button type="submit" class="upload-btn" disabled>
                            <i class="fas fa-upload"></i>
                            Start Analysis
                        </button>
                    </form>
                    
                    <div id="fileInfo" class="file-info" style="display: none;">
                        <i class="fas fa-check-circle"></i>
                        <span id="fileName"></span>
                    </div>
                    
                </div>
            </section>

            <!-- Loading Section -->
            <section id="loadingSection" class="loading-section" style="display: none;">
                <div class="loading-card">
                    <div class="spinner"></div>
                    <h3>Processing Excel File...</h3>
                    <div id="progressContainer" class="progress-container">
                        <div class="progress-bar">
                            <div id="progressBar" class="progress-bar-fill" style="width: 0%"></div>
                        </div>
                        <div id="progressText" class="progress-text">0%</div>
                    </div>
                    <div id="statusMessages" class="status-messages">
                        <div id="currentStatus" class="status-message">Initializing...</div>
                        <div id="statusDetails" class="status-details"></div>
                    </div>
                </div>
            </section>

            <!-- Results Section -->
            <section id="resultsSection" class="results-section">
                <div class="results-header">
                    <h2><i class="fas fa-chart-bar"></i> Analysis Results</h2>
                    <div class="action-buttons">
                        <div class="export-buttons">
                            <button id="reuploadBtn" class="btn btn-secondary">
                                <i class="fas fa-upload"></i> Re-upload
                            </button>
                            <button id="exportExcel" class="btn btn-primary">
                                <i class="fas fa-file-excel"></i> Export Excel
                            </button>
                            <button id="exportTxt" class="btn btn-secondary">
                                <i class="fas fa-file-alt"></i> Export Text
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="summary-cards">
                    <div class="summary-card">
                        <div class="card-icon total">
                            <i class="fas fa-database"></i>
                        </div>
                        <div class="card-content">
                            <h3 id="totalRecords">0</h3>
                            <p>Total Records</p>
                        </div>
                    </div>
                    
                    <div class="summary-card">
                        <div class="card-icon open">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="card-content">
                            <h3 id="openTickets">0</h3>
                            <p>Current Open Tickets</p>
                        </div>
                    </div>
                    
                    <div class="summary-card">
                        <div class="card-icon empty">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="card-content">
                            <h3 id="emptyFirstResponse">0</h3>
                            <p>Empty FirstResponse</p>
                        </div>
                    </div>
                </div>

                <!-- Detailed Results -->
                <div class="detailed-results">
                    <!-- First Row: Daily Statistics and Age Segments -->
                    <div class="result-row">
                        <!-- Daily Statistics -->
                        <div class="result-card">
                            <h3><i class="fas fa-calendar-day"></i> Daily Statistics</h3>
                            <div class="sort-controls">
                                <label for="sortOrder">Sort by Date:</label>
                                <select id="sortOrder" class="sort-select">
                                    <option value="desc" selected>Newest First</option>
                                    <option value="asc">Oldest First</option>
                                </select>
                            </div>
                            <div class="table-container">
                                <table id="dailyTable" class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>New Tickets</th>
                                            <th>Closed Tickets</th>
                                            <th>Open Tickets</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Age Segments -->
                        <div class="result-card">
                            <h3><i class="fas fa-clock"></i> Open Tickets Age Segments</h3>
                            <div class="table-container">
                                <table class="data-table age-table">
                                    <thead>
                                        <tr>
                                            <th>Time Period</th>
                                            <th>Ticket Count</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>≤24 hours</td>
                                            <td id="age24h" class="age-clickable" data-age-segment="24h">0</td>
                                        </tr>
                                        <tr>
                                            <td>24-48 hours</td>
                                            <td id="age24_48h" class="age-clickable" data-age-segment="24_48h">0</td>
                                        </tr>
                                        <tr>
                                            <td>48-72 hours</td>
                                            <td id="age48_72h" class="age-clickable" data-age-segment="48_72h">0</td>
                                        </tr>
                                        <tr>
                                            <td>>72 hours</td>
                                            <td id="age72h" class="age-clickable" data-age-segment="72h">0</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <!-- Age Details Container -->
                            <div id="ageDetailsContainer" class="details-container" style="display: none;">
                                <h4>Ticket Details</h4>
                                <div class="table-container">
                                    <table id="ageDetailsTable" class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Ticket Number</th>
                                                <th>Age</th>
                                                <th>Created</th>
                                                <th>Priority</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Will be populated by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Second Row: Empty FirstResponse -->
                    <div class="result-row">
                        <div class="result-card full-width">
                            <h3><i class="fas fa-exclamation-circle"></i> Empty FirstResponse Distribution</h3>
                            <div class="chart-container">
                                <canvas id="emptyFirstResponseChart"></canvas>
                            </div>
                            <!-- Empty FirstResponse Details Table -->
                            <div class="table-container">
                                <table id="emptyFirstResponseTable" class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Ticket Number</th>
                                            <th>Age</th>
                                            <th>Created</th>
                                            <th>Priority</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Error Section -->
            <section id="errorSection" class="error-section" style="display: none;">
                <div class="error-card">
                    <div class="error-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3>Processing Failed</h3>
                    <p id="errorMessage"></p>
                    <button onclick="hideError()" class="btn btn-primary">Try Again</button>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <p>OTRS Ticket Analysis System v{{ APP_VERSION }} | © 2025</p>
        </footer>
    </div>

    <!-- JavaScript -->
    <div id="updateModal" class="update-modal">
        <div class="update-modal-dialog">
            <button type="button" class="update-modal-close" id="updateModalClose" aria-label="关闭">&times;</button>
            <div class="update-modal-header">
                <h3><i class="fas fa-rocket"></i> 应用更新</h3>
                <p class="update-modal-meta">
                    当前版本：<span id="updateModalCurrentVersion">-</span>
                    <span class="meta-separator">|</span>
                    最新版本：<span id="updateModalLatestVersion">-</span>
                </p>
                <p class="update-modal-published">发布时间：<span id="updateModalPublished">-</span></p>
            </div>
            <div class="update-modal-body">
                <div class="update-modal-notes" id="updateModalNotes">
                    <p>正在加载发布说明...</p>
                </div>
                <a id="updateModalReleaseLink" href="#" target="_blank" rel="noopener" class="update-modal-link">
                    <i class="fas fa-external-link-alt"></i> 查看 GitHub 发布详情
                </a>
                <p class="update-modal-status" id="updateModalStatus"></p>
                <div class="update-modal-form">
                    <label for="updatePasswordInput">管理员密码</label>
                    <input type="password" id="updatePasswordInput" placeholder="请输入管理员密码以执行更新">
                </div>
                <div class="update-modal-feedback" id="updateModalFeedback"></div>
            </div>
            <div class="update-modal-footer">
                <button type="button" class="btn btn-outline-secondary btn-sm" id="updateModalRemindBtn">稍后提醒</button>
                <button type="button" class="btn btn-secondary btn-sm" id="updateModalCancelBtn">关闭</button>
                <button type="button" class="btn btn-warning btn-sm" id="updateModalForceReinstallBtn">
                    <i class="fas fa-redo"></i> 强制重新安装
                </button>
                <button type="button" class="btn btn-primary btn-sm" id="updateModalConfirmBtn">
                    <i class="fas fa-play"></i> 开始更新
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='js/script.js') }}?v={{ APP_VERSION }}"></script>
</body>
</html>

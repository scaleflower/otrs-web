<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>更新进度 - OTRS工单数据分析系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <style>
        .update-progress-card {
            border-left: 4px solid #007bff;
            margin-bottom: 1rem;
        }
        .step-log {
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
        .step-completed {
            background-color: #d4edda;
            border-left: 3px solid #28a745;
        }
        .step-current {
            background-color: #fff3cd;
            border-left: 3px solid #ffc107;
            animation: pulse 2s infinite;
        }
        .step-pending {
            background-color: #e9ecef;
            border-left: 3px solid #6c757d;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .progress-header {
            background-color: #e9ecef;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }
        .status-icon {
            font-size: 2rem;
            margin-right: 1rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row mt-3">
            <div class="col">
                <h2><i class="fas fa-sync-alt me-2"></i>更新进度</h2>
                <p class="text-muted">实时查看应用程序更新过程</p>
            </div>
            <div class="col-auto">
                <a href="/update/logs" class="btn btn-outline-secondary">
                    <i class="fas fa-history me-1"></i>更新日志
                </a>
                <a href="/" class="btn btn-outline-secondary ms-2">
                    <i class="fas fa-home me-1"></i>返回首页
                </a>
            </div>
        </div>

        <!-- Progress Container -->
        <div id="progressContainer">
            <div class="progress-header">
                <div class="d-flex align-items-center">
                    <i class="fas fa-spinner fa-spin status-icon text-primary"></i>
                    <div>
                        <h4 id="updateStatus">正在初始化更新...</h4>
                        <p class="mb-0 text-muted" id="updateDetails">请稍候，正在准备更新环境</p>
                    </div>
                </div>
            </div>

            <!-- Steps Progress -->
            <div class="mt-4">
                <h5><i class="fas fa-list-ol me-2"></i>更新步骤</h5>
                <div id="stepsContainer">
                    <!-- Steps will be populated here -->
                </div>
            </div>
        </div>

        <!-- Completion Message -->
        <div id="completionContainer" style="display: none;">
            <div class="text-center py-5">
                <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                <h3 class="mt-3">更新完成!</h3>
                <p class="text-muted">应用程序已成功更新，请等待系统重启</p>
                <div class="mt-4">
                    <a href="/" class="btn btn-primary">返回首页</a>
                    <a href="/update/logs" class="btn btn-outline-secondary ms-2">查看更新日志</a>
                </div>
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorContainer" style="display: none;">
            <div class="alert alert-danger">
                <h4><i class="fas fa-exclamation-triangle me-2"></i>更新出错</h4>
                <p id="errorMessage"></p>
                <div class="mt-3">
                    <a href="/update/logs" class="btn btn-danger">查看详细日志</a>
                    <a href="/" class="btn btn-outline-secondary ms-2">返回首页</a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let updateLogId = {{ update_log_id }};
        let lastProgress = null;
        let updateCompleted = false;
        let errorOccurred = false;
        let pollInterval = null;

        // Step definitions
        const updateSteps = [
            {name: 'backup_database', title: '备份数据库', order: 1},
            {name: 'fetch_repository', title: '获取版本元数据', order: 2},
            {name: 'checkout_version', title: '下载更新包', order: 3},
            {name: 'pull_changes', title: '同步更新文件', order: 4},
            {name: 'install_dependencies', title: '安装依赖包', order: 5},
            {name: 'run_migrations', title: '执行数据库迁移', order: 6},
            {name: 'restart_application', title: '重启应用程序', order: 7}
        ];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize steps display
            initializeSteps();
            
            // Start polling for progress
            startProgressPolling();
        });

        function initializeSteps() {
            const container = document.getElementById('stepsContainer');
            container.innerHTML = updateSteps.map(step => `
                <div class="step-log step-pending" id="step-${step.name}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${step.title}</strong>
                        </div>
                        <div>
                            <span class="badge bg-secondary">待处理</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function startProgressPolling() {
            // Poll every 2 seconds
            pollInterval = setInterval(fetchProgress, 2000);
            
            // Also fetch immediately
            fetchProgress();
        }

        async function fetchProgress() {
            if (updateCompleted || errorOccurred) {
                return;
            }
            
            try {
                const response = await fetch(`/update/progress/${updateLogId}`);
                const result = await response.json();
                
                if (result.success && result.progress) {
                    handleProgressUpdate(result.progress);
                }
            } catch (error) {
                console.error('Failed to fetch progress:', error);
            }
        }

        function handleProgressUpdate(progress) {
            // Skip duplicate updates
            if (lastProgress && lastProgress.timestamp === progress.timestamp) {
                return;
            }
            
            lastProgress = progress;
            
            if (progress.status === 'started') {
                // Update started
                document.getElementById('updateStatus').textContent = `正在更新到版本 ${progress.target_version}`;
                document.getElementById('updateDetails').textContent = '更新已开始，正在执行第一步...';
            } else if (progress.status === 'completed') {
                // Step completed
                const stepElement = document.getElementById(`step-${progress.step_name}`);
                if (stepElement) {
                    stepElement.className = 'step-log step-completed';
                    stepElement.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${getStepTitle(progress.step_name)}</strong>
                                ${progress.output ? `<div class="mt-1"><small>${progress.output}</small></div>` : ''}
                            </div>
                            <div>
                                <span class="badge bg-success">已完成</span>
                            </div>
                        </div>
                    `;
                }
                
                // Update status text
                const nextStep = updateSteps.find(step => step.order === progress.step_order + 1);
                if (nextStep) {
                    document.getElementById('updateDetails').textContent = `正在执行: ${nextStep.title}`;
                    
                    // Highlight next step
                    const nextStepElement = document.getElementById(`step-${nextStep.name}`);
                    if (nextStepElement) {
                        nextStepElement.className = 'step-log step-current';
                        nextStepElement.querySelector('.badge').className = 'badge bg-warning';
                        nextStepElement.querySelector('.badge').textContent = '进行中';
                    }
                } else {
                    // All steps completed
                    document.getElementById('updateStatus').textContent = '更新完成';
                    document.getElementById('updateDetails').textContent = '正在重启应用程序...';
                    updateCompleted = true;
                    
                    // Show completion screen after a delay
                    setTimeout(showCompletion, 3000);
                }
            }
        }

        function getStepTitle(stepName) {
            const step = updateSteps.find(s => s.name === stepName);
            return step ? step.title : stepName;
        }

        function showCompletion() {
            clearInterval(pollInterval);
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('completionContainer').style.display = 'block';
        }

        function showError(message) {
            clearInterval(pollInterval);
            errorOccurred = true;
            
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorContainer').style.display = 'block';
        }

        // Handle page visibility change to reduce polling when tab is not active
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // Slow down polling when tab is hidden
                if (pollInterval) {
                    clearInterval(pollInterval);
                    pollInterval = setInterval(fetchProgress, 5000);
                }
            } else {
                // Resume normal polling when tab is visible
                if (pollInterval) {
                    clearInterval(pollInterval);
                    pollInterval = setInterval(fetchProgress, 2000);
                }
                
                // Immediately fetch when tab becomes visible
                fetchProgress();
            }
        });
    </script>
</body>
</html>